# Page Table Self Mapping

**考虑在 X86-32 CPU上采用4KB页面大小、两级页表、页表自映射的虚拟存储系统。如果在虚拟地址空间中，4MB 的页表区域从虚拟地址 0xD0000000 开始，请回答自映射页表项的虚拟地址。**

首先考虑一下虚拟地址和物理地址的转换过程，页面4KB对齐，页表初始位置的物理地址为`pdbr(20)|0x000(12)`（括号表示位数，`|`表示连接），每个页表项4B，现在给定一个虚拟地址`pde(10)|pte(10)|offset(12)`，要将它转换为物理地址，首先计算出一级页表中的页表项的物理地址`pdbr|pde|0b00`，从内存中取出一级页表项，其前20位为物理页号`ppn1(20)`，它对应第二级页表的物理页号，然后计算出二级页表中的页表项的物理地址`ppn1|pte|0b00`，从内存中取出二级页表项，其前20位为物理页号`ppn2(20)`，它就是最终的物理页号，最终的物理地址就是`ppn2|offset`。

现在考虑页表自映射，假设自映射页表项的虚拟地址为`pde(10)|pte(10)|offset(12)`，现在将它转换为物理地址，考虑到自映射，一级页表查到页表项的物理页号指向一级页表所在页，即`ppn1 = pdbr`，然后查物理页号为`ppn1`的二级页表（其实就是查一级页表），二级页表查到的页表项跟一级页表查到的页表项是相同的，即`ppn2 = ppn1`且`pde = pte := E(10)`，其中`E`表示自映射页表项是第一/二级页表中的第`E`项，一个页表项4B，因此自映射页表项在一/二级页表所在4K页的页内偏移为`offset = 4E`，所以自映射页表项的虚拟地址可表示为`E|E|4E`。理论上`E`可以随便取，但是一个`E`同时也对应了4MB二级页表存储的一个虚拟地址空间`E|0x000000(22) ~ E|0x3fffff(22)`，以及4KB一级页表的一个虚拟地址空间`E|E|0x000(12) ~ E|E|0xfff(12)`。这里题目说4MB页表区域从虚拟地址`0xD0000000`开始，即到`0xD03fffff`结束，由最高10位可以确定`E=0x340`，最后得到自映射页表项的虚拟地址为`0xD0340D00`。

自映射页表项的物理地址也可以确定，就是`pdbr|4E`，注意`pdbr`存储的是物理地址，可以随便取值，跟这里的虚拟地址`0xD0000000`没有任何关系。具体来说，进一步假设`pdbr = 0x12345`，则`pfn1 = pfn2 = 0x12345`，自映射页表项的物理地址为`0x12345D00`。
